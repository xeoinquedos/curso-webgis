{"version":3,"file":"IntermediateCanvas.js","sources":["../../../../src/ol/renderer/canvas/IntermediateCanvas.js"],"sourcesContent":["/**\n * @module ol/renderer/canvas/IntermediateCanvas\n */\nimport {scale as scaleCoordinate} from '../../coordinate.js';\nimport {createCanvasContext2D} from '../../dom.js';\nimport {containsExtent, intersects} from '../../extent.js';\nimport {VOID} from '../../functions.js';\nimport CanvasLayerRenderer from '../canvas/Layer.js';\nimport {create as createTransform, apply as applyTransform} from '../../transform.js';\n\nclass IntermediateCanvasRenderer extends CanvasLayerRenderer {\n\n  /**\n   * @param {module:ol/layer/Layer} layer Layer.\n   */\n  constructor(layer) {\n\n    super(layer);\n\n    /**\n     * @protected\n     * @type {module:ol/transform~Transform}\n     */\n    this.coordinateToCanvasPixelTransform = createTransform();\n\n    /**\n     * @private\n     * @type {CanvasRenderingContext2D}\n     */\n    this.hitCanvasContext_ = null;\n\n  }\n\n  /**\n   * @inheritDoc\n   */\n  composeFrame(frameState, layerState, context) {\n\n    this.preCompose(context, frameState);\n\n    const image = this.getImage();\n    if (image) {\n\n      // clipped rendering if layer extent is set\n      const extent = layerState.extent;\n      const clipped = extent !== undefined &&\n          !containsExtent(extent, frameState.extent) &&\n          intersects(extent, frameState.extent);\n      if (clipped) {\n        this.clip(context, frameState, /** @type {module:ol/extent~Extent} */ (extent));\n      }\n\n      const imageTransform = this.getImageTransform();\n      // for performance reasons, context.save / context.restore is not used\n      // to save and restore the transformation matrix and the opacity.\n      // see http://jsperf.com/context-save-restore-versus-variable\n      const alpha = context.globalAlpha;\n      context.globalAlpha = layerState.opacity;\n\n      // for performance reasons, context.setTransform is only used\n      // when the view is rotated. see http://jsperf.com/canvas-transform\n      const dx = imageTransform[4];\n      const dy = imageTransform[5];\n      const dw = image.width * imageTransform[0];\n      const dh = image.height * imageTransform[3];\n      context.drawImage(image, 0, 0, +image.width, +image.height,\n        Math.round(dx), Math.round(dy), Math.round(dw), Math.round(dh));\n      context.globalAlpha = alpha;\n\n      if (clipped) {\n        context.restore();\n      }\n    }\n\n    this.postCompose(context, frameState, layerState);\n  }\n\n  /**\n   * @abstract\n   * @return {HTMLCanvasElement|HTMLVideoElement|HTMLImageElement} Canvas.\n   */\n  getImage() {}\n\n  /**\n   * @abstract\n   * @return {!module:ol/transform~Transform} Image transform.\n   */\n  getImageTransform() {}\n\n  /**\n   * @inheritDoc\n   */\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\n    const layer = this.getLayer();\n    const source = layer.getSource();\n    const resolution = frameState.viewState.resolution;\n    const rotation = frameState.viewState.rotation;\n    const skippedFeatureUids = frameState.skippedFeatureUids;\n    return source.forEachFeatureAtCoordinate(\n      coordinate, resolution, rotation, hitTolerance, skippedFeatureUids,\n      /**\n       * @param {module:ol/Feature|module:ol/render/Feature} feature Feature.\n       * @return {?} Callback result.\n       */\n      function(feature) {\n        return callback.call(thisArg, feature, layer);\n      });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  forEachLayerAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\n    if (!this.getImage()) {\n      return undefined;\n    }\n\n    if (this.getLayer().getSource().forEachFeatureAtCoordinate !== VOID) {\n      // for ImageCanvas sources use the original hit-detection logic,\n      // so that for example also transparent polygons are detected\n      return super.forEachLayerAtCoordinate(arguments);\n    } else {\n      const pixel = applyTransform(this.coordinateToCanvasPixelTransform, coordinate.slice());\n      scaleCoordinate(pixel, frameState.viewState.resolution / this.renderedResolution);\n\n      if (!this.hitCanvasContext_) {\n        this.hitCanvasContext_ = createCanvasContext2D(1, 1);\n      }\n\n      this.hitCanvasContext_.clearRect(0, 0, 1, 1);\n      this.hitCanvasContext_.drawImage(this.getImage(), pixel[0], pixel[1], 1, 1, 0, 0, 1, 1);\n\n      const imageData = this.hitCanvasContext_.getImageData(0, 0, 1, 1).data;\n      if (imageData[3] > 0) {\n        return callback.call(thisArg, this.getLayer(), imageData);\n      } else {\n        return undefined;\n      }\n    }\n  }\n}\n\n\nexport default IntermediateCanvasRenderer;\n"],"names":["super","const"],"mappings":"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"}